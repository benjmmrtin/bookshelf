<!DOCTYPE html>

<html>
<head>
  <title>Bookshelf.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1>Bookshelf.js</h1>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              
<blockquote>
<p>(c) 2013 Tim Griesser
Bookshelf may be freely distributed under the MIT license.
For details and documentation:
<a href="http://bookshelfjs.org">http://bookshelfjs.org</a></p>
</blockquote>
<h2>Initial Setup</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              

            </div>
            
            <div class="content"><div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">Bookshelf</span> <span class="o">=</span> <span class="p">{};</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              
<p>Keep a reference to our own local copy of Backbone, in case we want to use
this specific copy of Backbone elsewhere in the application.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">Backbone</span> <span class="o">=</span> <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">Backbone</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./vendor/backbone&#39;</span><span class="p">);</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              
<p>Local dependency references.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">_</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">Q</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">Knex</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../knex/knex&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">inflection</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;inflection&#39;</span><span class="p">);</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              
<p>Attach <code>Knex</code> &amp; <code>Knex.Transaction</code> for convenience.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">Knex</span> <span class="o">=</span> <span class="nx">Knex</span><span class="p">;</span>
  <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">Transaction</span> <span class="o">=</span> <span class="nx">Knex</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              
<p>Keep in sync with package.json.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">VERSION</span> <span class="o">=</span> <span class="s1">&#39;0.0.0&#39;</span><span class="p">;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              
<p>We&#39;re using <code>Backbone.Events</code> rather than <code>EventEmitter</code>,
for API consistency and portability, but adding some
methods to make the API feel a bit more like Node&#39;s.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">Events</span> <span class="o">=</span> <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">Events</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">;</span>
      <span class="nx">Events</span><span class="p">.</span><span class="nx">removeAllListeners</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span> <span class="p">};</span>
      <span class="nx">Events</span><span class="p">.</span><span class="nx">emit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">};</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              
<p><code>Bookshelf</code> may be used as a top-level pub-sub bus.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Bookshelf</span><span class="p">,</span> <span class="nx">Events</span><span class="p">);</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              
<p>Base functions which are mixed-in to the
<code>Model</code>, <code>Collection</code>, and <code>EagerRelation</code> prototypes.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">Base</span> <span class="o">=</span> <span class="p">{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              
<p>If there are no arguments, return the current object&#39;s
query builder (or create a new one). If there are arguments,
call the query builder with the first argument, applying the
rest.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">query</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">builder</span> <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">builder</span> <span class="o">=</span> <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">Knex</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;tableName&#39;</span><span class="p">)));</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">toArray</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">builder</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">builder</span><span class="p">[</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">builder</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              
<p>Reset the query builder, called internally
after a query completes.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">resetQuery</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">builder</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              
<p>Eager loads relationships onto an already populated
<code>Model</code> or <code>Collection</code> instance.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">load</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">relations</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">data</span><span class="p">;</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">options</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">shallow</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">withRelated</span><span class="o">:</span> <span class="nx">relations</span>
      <span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">target</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">();</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">target</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">)];</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">EagerRelation</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">processRelated</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">model</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              
<p>Creates and returns a new <code>Bookshelf.Sync</code> instance.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">sync</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">Sync</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              
<h2>Bookshelf.Model</h2>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              
<p>A similar implementation to the <code>Backbone.Model</code>
constructor, except that defaults are not set until the
object is persisted, and the collection property is not used.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">Model</span> <span class="o">=</span> <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">Model</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="nx">attributes</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="nx">options</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">cid</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniqueId</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">relations</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_configure</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">parse</span><span class="p">)</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">changed</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="p">};</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              
<p>List of attributes attached directly from the constructor&#39;s options object.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">modelProps</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;tableName&#39;</span><span class="p">,</span> <span class="s1">&#39;fillable&#39;</span><span class="p">,</span> <span class="s1">&#39;hasTimestamps&#39;</span><span class="p">,</span> <span class="s1">&#39;exists&#39;</span><span class="p">,</span> <span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="s1">&#39;response&#39;</span>
  <span class="p">];</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              
<p>Extend <code>Bookshelf.Model.prototype</code> with all necessary methods and properties.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Events</span><span class="p">,</span> <span class="nx">Base</span><span class="p">,</span> <span class="p">{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              
<p>The database table associated with the model.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">tableName</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              
<p>Array of attributes which can be set with
mass-assignment (whitelisting).</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">fillable</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              
<p>Array of attributes which cannot be set with
mass-assignment (blacklisting).</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">guarded</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              
<p>Indicates if the model should be timestamped.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">hasTimestamps</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              
<p>Ensures the options sent to the model are properly attached.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">_configure</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">)</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">),</span> <span class="nx">options</span><span class="p">);</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pick</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">modelProps</span><span class="p">));</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              
<p>Sets an attribute on the <code>Model</code>. If the key is an object, 
check for any mass-assignment guards defined on the model
and filter as appropriate. If any filtered items are detected,
fire an event on the model and on the <code>Bookshelf</code> object.
Passes through to <code>set</code> on <code>Backbone.Model</code>.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">attrs</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">attrs</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="p">(</span><span class="nx">val</span> <span class="o">||</span> <span class="p">{});</span>
        
        <span class="kd">var</span> <span class="nx">fillable</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fillable</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">guarded</span>  <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">guarded</span><span class="p">;</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">fillable</span> <span class="o">||</span> <span class="nx">guarded</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">sanitized</span> <span class="o">=</span> <span class="p">{};</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">fillable</span><span class="p">)</span> <span class="nx">sanitized</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pick</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">fillable</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">guarded</span><span class="p">)</span> <span class="nx">sanitized</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">omit</span><span class="p">(</span><span class="nx">sanitized</span><span class="p">,</span> <span class="nx">guarded</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">filtered</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">omit</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">sanitized</span><span class="p">));</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">filtered</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;inaccessible&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">filtered</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
            <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;inaccessible&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">filtered</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="nx">attrs</span> <span class="o">=</span> <span class="nx">sanitized</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="p">(</span><span class="nx">attrs</span> <span class="o">=</span> <span class="p">{})[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
        <span class="nx">options</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{});</span>
      <span class="p">}</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              
<p>A validation skip is required to continue using the existing <code>Backbone#set</code>
method, as we want to chain here rather than returning a promise.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>      <span class="nx">options</span><span class="p">.</span><span class="nx">validate</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              
<p>The <code>hasOne</code> relation specifies that this table has exactly one of
another type of object, specified by a foreign key in the other table. The foreign key is assumed
to be the singular of this object&#39;s <code>tableName</code> with an <code>_id</code> suffix, but a custom <code>foreignKey</code>
attribute may also be specified.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">hasOne</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Target</span><span class="p">,</span> <span class="nx">foreignKey</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relatesTo</span><span class="p">(</span><span class="nx">Target</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;hasOne&#39;</span><span class="p">,</span>
        <span class="nx">foreignKey</span><span class="o">:</span> <span class="nx">foreignKey</span> <span class="o">||</span> <span class="nx">inflection</span><span class="p">.</span><span class="nx">singularize</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;tableName&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_id&#39;</span>
      <span class="p">});</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              
<p>The <code>hasMany</code> relation specifies that this object has one or
more rows in another table which match on this object&#39;s primary key. The foreign key is assumed
to be the singular of this object&#39;s <code>tableName</code> with an <code>_id</code> suffix, but a custom <code>foreignKey</code>
attribute may also be specified.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">hasMany</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Target</span><span class="p">,</span> <span class="nx">foreignKey</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relatesTo</span><span class="p">(</span><span class="nx">Target</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;hasMany&#39;</span><span class="p">,</span>
        <span class="nx">foreignKey</span><span class="o">:</span> <span class="nx">foreignKey</span> <span class="o">||</span> <span class="nx">inflection</span><span class="p">.</span><span class="nx">singularize</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;tableName&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_id&#39;</span>
      <span class="p">});</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              
<p>A reverse <code>hasOne</code> relation, the <code>belongsTo</code>, where the specified key in this table
matches the primary <code>idAttribute</code> of another table.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">belongsTo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Target</span><span class="p">,</span> <span class="nx">otherKey</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relatesTo</span><span class="p">(</span><span class="nx">Target</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;belongsTo&#39;</span><span class="p">,</span>
        <span class="nx">foreignKey</span><span class="o">:</span> <span class="nx">Target</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">idAttribute</span><span class="p">,</span>
        <span class="nx">otherKey</span><span class="o">:</span> <span class="nx">otherKey</span> <span class="o">||</span> <span class="nx">inflection</span><span class="p">.</span><span class="nx">singularize</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="nx">Target</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s1">&#39;tableName&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_id&#39;</span>
      <span class="p">});</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              
<p>A <code>belongsToMany</code> relation is when there are many-to-many relation
between two models, with a joining table. The joinTableName may be replaced with another
object, will serve as the joining model.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">belongsToMany</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Target</span><span class="p">,</span> <span class="nx">joinTableName</span><span class="p">,</span> <span class="nx">foreignKey</span><span class="p">,</span> <span class="nx">otherKey</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relatesTo</span><span class="p">(</span><span class="nx">Target</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;belongsToMany&#39;</span><span class="p">,</span>
        <span class="nx">otherKey</span><span class="o">:</span> <span class="nx">otherKey</span>     <span class="o">||</span> <span class="nx">inflection</span><span class="p">.</span><span class="nx">singularize</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;tableName&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_id&#39;</span><span class="p">,</span>
        <span class="nx">foreignKey</span><span class="o">:</span> <span class="nx">foreignKey</span> <span class="o">||</span> <span class="nx">inflection</span><span class="p">.</span><span class="nx">singularize</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="nx">Target</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s1">&#39;tableName&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_id&#39;</span><span class="p">,</span>
        <span class="nx">joinTableName</span><span class="o">:</span> <span class="nx">joinTableName</span> <span class="o">||</span> <span class="p">[</span>
          <span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;tableName&#39;</span><span class="p">),</span> 
          <span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="nx">Target</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s1">&#39;tableName&#39;</span><span class="p">)</span>
        <span class="p">].</span><span class="nx">sort</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
      <span class="p">});</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              
<p>Fetch a model based on the currently set attributes,
returning a model to the callback, along with any options.
Returns a deferred promise through the Bookshelf.sync.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="nx">first</span><span class="p">();</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              
<p>Sets and saves the hash of model attributes,
If the server returns an attributes hash that differs,
the model&#39;s state will be <code>set</code> again.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">save</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">defaults</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">,</span> <span class="nx">success</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              
<p>Handle both <code>&quot;key&quot;, value</code> and <code>{key: value}</code> -style arguments.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">key</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">attrs</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">options</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{});</span>
        <span class="p">(</span><span class="nx">attrs</span> <span class="o">=</span> <span class="p">{})[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
      <span class="p">}</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              
<p>Don&#39;t allow setting an id attribute on save, unless the
<code>{existing: true}</code> flag is set on the options hash.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">attrs</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">idAttribute</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="nx">id</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">existing</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Q</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;The model cannot be saved with an idAttribute&#39;</span><span class="p">));</span>
      <span class="p">}</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              
<p>Handle the defaults at the <code>save</code> level rather than the
object creation level.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>      <span class="nx">defaults</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;defaults&#39;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">defaults</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">attrs</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">({},</span> <span class="nx">attrs</span><span class="p">,</span> <span class="nx">defaults</span><span class="p">);</span>
      <span class="p">}</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              
<p>If attributes exist, save acts as <code>set(attr).save(null, opts)</code>.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>

      <span class="nx">options</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span><span class="nx">validate</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="nx">options</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

      <span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_validate</span><span class="p">,</span> <span class="k">this</span><span class="p">),</span> <span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              
<p>If the model has timestamp columns,
set them as attributes on the model</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">hasTimestamps</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">model</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">sync</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">sync</span><span class="p">[(</span><span class="nx">model</span><span class="p">.</span><span class="nx">isNew</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;insert&#39;</span> <span class="o">:</span> <span class="s1">&#39;update&#39;</span><span class="p">)]();</span>
      
      <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              
<p>After a successful database save, the id is updated
if the model was created, otherwise the success function is called</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>        <span class="nx">model</span><span class="p">.</span><span class="nx">resetQuery</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">insertId</span><span class="p">)</span> <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">idAttribute</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">insertId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">success</span><span class="p">)</span> <span class="nx">success</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="nx">model</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;fetched&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">resp</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              
<p>Destroy a model, calling a delete based on its <code>idAttribute</code>.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{});</span>
      <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="s1">&#39;del&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">model</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">model</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              
<p>Returns an object containing the model attributes,
along with the <code>toJSON</code> value of any relations,
unless <code>{shallow: true}</code> is passed in the <code>options</code>.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">shallow</span><span class="p">)</span> <span class="k">return</span> <span class="nx">attrs</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">relations</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">relations</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">relations</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">attrs</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">relations</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">toJSON</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">attrs</span><span class="p">;</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              
<p>Sets the timestamps before saving the model.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">timestamp</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;updated_at&#39;</span><span class="p">,</span> <span class="nx">d</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isNew</span><span class="p">(</span><span class="nx">options</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="nx">d</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              
<p>Check the validity of a model.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">isValid</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_validate</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">options</span><span class="p">,</span> <span class="p">{</span><span class="nx">validate</span><span class="o">:</span> <span class="kc">true</span><span class="p">}));</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              
<p>Creates a new relation, from the current object to the
&#39;target&#39; object (collection or model), passing a hash of
options which can include the <code>type</code> of relation.
The <code>hasOne</code> and <code>belongsTo</code> relations may only &quot;target&quot; a <code>Model</code>.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">_relatesTo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Target</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">target</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">multi</span> <span class="o">=</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;hasMany&#39;</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;belongsToMany&#39;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">multi</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Target</span><span class="p">.</span><span class="nx">prototype</span> <span class="k">instanceof</span> <span class="nx">Model</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;The `&#39;</span><span class="o">+</span><span class="nx">type</span><span class="o">+</span><span class="s1">&#39;` related object must be a Bookshelf.Model&#39;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">Target</span><span class="p">.</span><span class="nx">prototype</span> <span class="k">instanceof</span> <span class="nx">Model</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Target</span> <span class="o">=</span> <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span><span class="nx">model</span><span class="o">:</span> <span class="nx">Target</span><span class="p">});</span>
      <span class="p">}</span></pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              
<p>If we&#39;re handling an eager loaded related model,
we need to keep a reference to the original constructor,
to assemble the correct object once the eager matching is finished.
Otherwise, we need to grab the <code>foreignKey</code> value for building the query.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_isEager</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">multi</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">options</span><span class="p">.</span><span class="nx">modelCtor</span> <span class="o">=</span> <span class="nx">Target</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">model</span><span class="p">;</span>
          <span class="nx">options</span><span class="p">.</span><span class="nx">collectionCtor</span> <span class="o">=</span> <span class="nx">Target</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">options</span><span class="p">.</span><span class="nx">modelCtor</span> <span class="o">=</span> <span class="nx">Target</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;belongsTo&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">options</span><span class="p">.</span><span class="nx">fkValue</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">otherKey</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">options</span><span class="p">.</span><span class="nx">fkValue</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              
<p>Create a new instance of the <code>Model</code> or <code>Collection</code>, and set the
<code>_relation</code> options as a property on the instance.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>      <span class="nx">target</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Target</span><span class="p">();</span>
      <span class="nx">target</span><span class="p">.</span><span class="nx">_relation</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              
<p>Extend the relation with relation-specific methods.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;belongsToMany&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">pivotHelpers</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              
<p>Run validation against the next complete set of model attributes,
returning <code>true</code> if all is well. Otherwise, fire a general
<code>&quot;error&quot;</code> event and call the error callback, if specified.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">_validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">validate</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">validate</span><span class="p">)</span> <span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
      <span class="nx">attrs</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">validate</span><span class="p">,</span> <span class="k">this</span><span class="p">),</span> <span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">&amp;&amp;</span> <span class="nx">resp</span> <span class="o">!==</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">model</span><span class="p">.</span><span class="nx">validationError</span> <span class="o">=</span> <span class="nx">resp</span><span class="p">;</span>
          <span class="nx">model</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;invalid&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">resp</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="kd">var</span> <span class="nx">Collection</span> <span class="o">=</span> <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">Collection</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">models</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pick</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">collectionProps</span><span class="p">));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_reset</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">relations</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">models</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">(</span><span class="nx">models</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="nx">options</span><span class="p">));</span>
  <span class="p">};</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              
<p>List of attributes attached directly from the constructor&#39;s options object.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">collectionProps</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;comparator&#39;</span><span class="p">,</span> <span class="s1">&#39;perPage&#39;</span><span class="p">,</span> <span class="s1">&#39;forPage&#39;</span>
  <span class="p">];</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              
<p>Extend the Collection&#39;s prototype with the base methods</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">omit</span><span class="p">(</span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">),</span> <span class="nx">Events</span><span class="p">,</span> <span class="nx">Base</span><span class="p">,</span> <span class="p">{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              
<p>Sets the <code>perPage</code> limit, to help with pagination.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">perPage</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              
<p>Used in combination with <code>perPage</code>, this is the the current 
&quot;page&quot; we&#39;re querying for.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">forPage</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              
<p>Set the batch size for large query sets.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">batchSize</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              
<p>Fetch the models for this collection, resetting the models for the query
when they arrive.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{});</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="nx">select</span><span class="p">();</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              
<p>The <code>tableName</code> on the associated Model, used in relation building.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">tableName</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s1">&#39;tableName&#39;</span><span class="p">);</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              
<p>The <code>idAttribute</code> on the associated Model, used in relation building.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">idAttribute</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">idAttribute</span><span class="p">;</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              
<p>Prepare a model or hash of attributes to be added to this collection.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">_prepareModel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">attrs</span> <span class="k">instanceof</span> <span class="nx">Model</span><span class="p">)</span> <span class="k">return</span> <span class="nx">attrs</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              
<p>Gets the number of pages, based on the <code>perPage</code> and <code>forPage</code> 
parameters on the collection.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">getPageCount</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="p">},</span>

    <span class="nx">first</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">columns</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">select</span><span class="p">(</span><span class="nx">columns</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">models</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              
<p>Destroy all of the models on the collection</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">destroyAll</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">idAttr</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">idAttribute</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">whereIn</span><span class="p">(</span><span class="nx">idAttr</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pick</span><span class="p">(</span><span class="nx">idAttr</span><span class="p">)).</span><span class="nx">del</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
    <span class="p">}</span>

  <span class="p">});</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              
<h2>Relations</h2>

            </div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              
<p>Temporary helper object for handling the response of an <code>EagerRelation</code> load.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">RelatedModels</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">models</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">models</span> <span class="o">=</span> <span class="nx">models</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">RelatedModels</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pick</span><span class="p">(</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s1">&#39;find&#39;</span><span class="p">,</span> <span class="s1">&#39;where&#39;</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="s1">&#39;findWhere&#39;</span><span class="p">));</span></pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              
<p>An <code>EagerRelation</code> object temporarily stores the models from an eager load,
and handles matching eager loaded objects with their parent(s).</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">EagerRelation</span> <span class="o">=</span> <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">EagerRelation</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">parentResponse</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">parentResponse</span> <span class="o">=</span> <span class="nx">parentResponse</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">EagerRelation</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Base</span><span class="p">,</span> <span class="p">{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              
<p>Fetch the nested related items, and handle the responses.
Returns a deferred object, with the cumulative handling of
multiple (potentially nested) relations.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">models</span>  <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="kd">var</span> <span class="nx">opts</span>    <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relation</span><span class="p">;</span>

      <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">addEagerConstraints</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">parentResponse</span><span class="p">);</span>
      
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">select</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">columns</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
      
        <span class="nx">current</span><span class="p">.</span><span class="nx">resetQuery</span><span class="p">();</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              
<p>Only find additional related items &amp; process if
there is a response from the query.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">&amp;&amp;</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

          <span class="kd">var</span> <span class="nx">filteredResp</span> <span class="o">=</span> <span class="nx">skim</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span></pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              
<p>We can just push the models onto the collection, rather than resetting.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">filteredResp</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">models</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">modelCtor</span><span class="p">(</span><span class="nx">filteredResp</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
          <span class="p">}</span>

          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">withRelated</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">modelCtor</span><span class="p">();</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">EagerRelation</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">).</span><span class="nx">processRelated</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">models</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">processRelated</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">name</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">handled</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">handled</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="kd">var</span> <span class="nx">withRelated</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">withRelated</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">subRelated</span> <span class="o">=</span> <span class="p">{};</span></pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              
<p>Eager load each of the <code>withRelated</code> relation item, splitting on &#39;.&#39;
which indicates a nested eager load.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">withRelated</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">related</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">withRelated</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="nx">name</span> <span class="o">=</span> <span class="nx">related</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span></pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              
<p>Add additional eager items to an array, to load at the next level in the query.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">related</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">subRelated</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="nx">subRelated</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]);</span>
          <span class="nx">subRelated</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">related</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">));</span>
        <span class="p">}</span></pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              
<p>Only allow one of a certain nested type per-level.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">handled</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="k">continue</span><span class="p">;</span>
        </pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              
<p>Internal flag to determine whether to set the ctor(s) on the _relation hash.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>        <span class="nx">target</span><span class="p">.</span><span class="nx">_isEager</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">relation</span> <span class="o">=</span> <span class="nx">target</span><span class="p">[</span><span class="nx">name</span><span class="p">]();</span>
        <span class="nx">target</span><span class="p">.</span><span class="nx">_isEager</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              
<p>Set the parent&#39;s response, for purposes of setting query constraints.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>        <span class="nx">relation</span><span class="p">.</span><span class="nx">_relation</span><span class="p">.</span><span class="nx">parentResponse</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentResponse</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">relation</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39; is not defined on the model.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">handled</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">relation</span><span class="p">;</span>
      <span class="p">}</span></pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              
<p>Fetch all eager loaded models.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">pendingDeferred</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="kd">var</span> <span class="nx">pendingNames</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pendingNames</span> <span class="o">=</span> <span class="p">[];</span>
      
      <span class="k">for</span> <span class="p">(</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">handled</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">pendingNames</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
        <span class="nx">pendingDeferred</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fetch</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">handled</span><span class="p">[</span><span class="nx">name</span><span class="p">],</span> <span class="p">{</span>
          <span class="nx">transacting</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">transacting</span><span class="p">,</span>
          <span class="nx">withRelated</span><span class="o">:</span> <span class="nx">subRelated</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
        <span class="p">}));</span>
      <span class="p">}</span></pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              
<p>Return a deferred handler for all of the nested object sync
returning the original response when these syncs are complete.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>      <span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">pendingDeferred</span><span class="p">).</span><span class="nx">spread</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">matchResponses</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              
<p>Handles the matching against an eager loaded relation.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">matchResponses</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">handled</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">handled</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">toArray</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span></pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              
<p>Pair each of the query responses with the parent models.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        </pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              
<p>Get the current relation this response matches up with, based
on the pendingNames array.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pendingNames</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">relation</span> <span class="o">=</span> <span class="nx">handled</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">_relation</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">relatedModels</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RelatedModels</span><span class="p">(</span><span class="nx">relation</span><span class="p">.</span><span class="nx">models</span><span class="p">);</span></pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              
<p>If the parent is a collection, we need to loop over each of the
models and attach the appropriate sub-models, since they are
fetched eagerly. We will re-use the same models for each association level.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span> <span class="k">instanceof</span> <span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">models</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">models</span><span class="p">;</span>
          </pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              
<p>Attach the appropriate related items onto the parent model.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l2</span> <span class="o">=</span> <span class="nx">models</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i2</span> <span class="o">&lt;</span> <span class="nx">l2</span><span class="p">;</span> <span class="nx">i2</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">models</span><span class="p">[</span><span class="nx">i2</span><span class="p">];</span>
            <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">eagerRelated</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">relation</span><span class="p">,</span> <span class="nx">relatedModels</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="nx">m</span><span class="p">.</span><span class="nx">relations</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              
<p>If this is a hasOne or belongsTo, we only choose a single item from
the relation.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;hasOne&#39;</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;belongsTo&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">parent</span><span class="p">.</span><span class="nx">relations</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">parent</span><span class="p">.</span><span class="nx">relations</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">_relation</span><span class="p">.</span><span class="nx">collectionCtor</span><span class="p">(</span><span class="nx">relation</span><span class="p">.</span><span class="nx">models</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentResponse</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span></pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              
<p>Adds the basic relation constraints onto the query.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">addConstraints</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;belongsToMany&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">constraints</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">belongsToMany</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              
<p>Adds eager loading relationship constraints onto the query.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">addEagerConstraints</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;belongsToMany&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">constraints</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">resp</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">belongsToMany</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">resp</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              
<p>Handles the &quot;eager related&quot; relationship matching.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">eagerRelated</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">eager</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">relation</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">_relation</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">where</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s2">&quot;hasOne&quot;</span><span class="o">:</span>
      <span class="k">case</span> <span class="s2">&quot;belongsTo&quot;</span><span class="o">:</span>
        <span class="nx">where</span><span class="p">[</span><span class="nx">relation</span><span class="p">.</span><span class="nx">foreignKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">eager</span><span class="p">.</span><span class="nx">findWhere</span><span class="p">(</span><span class="nx">where</span><span class="p">);</span>
      <span class="k">case</span> <span class="s2">&quot;hasMany&quot;</span><span class="o">:</span>
        <span class="nx">where</span><span class="p">[</span><span class="nx">relation</span><span class="p">.</span><span class="nx">foreignKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">collectionCtor</span><span class="p">(</span><span class="nx">eager</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">where</span><span class="p">));</span>
      <span class="k">case</span> <span class="s2">&quot;belongsToMany&quot;</span><span class="o">:</span>
        <span class="nx">where</span><span class="p">[</span><span class="s1">&#39;pivot_&#39;</span> <span class="o">+</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">otherKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">collectionCtor</span><span class="p">(</span><span class="nx">eager</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">where</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              
<p>Standard constraints for regular or eager loaded relations.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">constraints</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">relation</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">_relation</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">target</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;whereIn&#39;</span><span class="p">,</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">foreignKey</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="s1">&#39;idAttribute&#39;</span><span class="p">)));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">target</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;where&#39;</span><span class="p">,</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">foreignKey</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">fkValue</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
  <span class="p">};</span></pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              
<p>Helper function for adding the constraints needed on a eager load.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">belongsToMany</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">relation</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">_relation</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">columns</span> <span class="o">=</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">columns</span> <span class="o">||</span> <span class="p">(</span><span class="nx">relation</span><span class="p">.</span><span class="nx">columns</span> <span class="o">=</span> <span class="p">[]);</span>
    
    <span class="kd">var</span> <span class="nx">joinTableName</span> <span class="o">=</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">joinTableName</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">otherKey</span> <span class="o">=</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">otherKey</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">foreignKey</span> <span class="o">=</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">foreignKey</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">pivotColumns</span> <span class="o">=</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">pivotColumns</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">idAttribute</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="s1">&#39;idAttribute&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">tableName</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="s1">&#39;tableName&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">query</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">builder</span><span class="p">.</span><span class="nx">columns</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">columns</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">columns</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tableName</span> <span class="o">+</span> <span class="s1">&#39;.*&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">columns</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
      <span class="nx">joinTableName</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">otherKey</span> <span class="o">+</span> <span class="s1">&#39; as &#39;</span> <span class="o">+</span> <span class="s1">&#39;pivot_&#39;</span> <span class="o">+</span> <span class="nx">otherKey</span><span class="p">,</span>
      <span class="nx">joinTableName</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">foreignKey</span> <span class="o">+</span> <span class="s1">&#39; as &#39;</span> <span class="o">+</span> <span class="s1">&#39;pivot_&#39;</span> <span class="o">+</span> <span class="nx">foreignKey</span>
    <span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">pivotColumns</span><span class="p">)</span> <span class="nx">columns</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">columns</span><span class="p">,</span> <span class="nx">pivotColumns</span><span class="p">);</span>
    
    <span class="nx">builder</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">joinTableName</span><span class="p">,</span> <span class="nx">tableName</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">idAttribute</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="nx">joinTableName</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">foreignKey</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">whereIn</span><span class="p">(</span><span class="nx">joinTableName</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">otherKey</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">idAttribute</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">joinTableName</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">otherKey</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">fkValue</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
  <span class="p">};</span></pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              
<h2>Extending Methods</h2>

            </div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              
<h2>Sync</h2>

            </div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              
<p>Sync is the dispatcher for any queries to the database,
taking the <code>model</code> or <code>collection</code> being queried, along with
a hash of options that are used in the various query methods.
If the <code>transacting</code> option is set, the query is assumed to be
part of a transaction, and this information is passed along to Knex.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">Sync</span> <span class="o">=</span> <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">Sync</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">model</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">query</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">relation</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">_relation</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">relation</span> <span class="o">&amp;&amp;</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">fkValue</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">addConstraints</span><span class="p">(</span><span class="nx">relation</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">model</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">transacting</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">transacting</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">transacting</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Sync</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              
<p>Select the first item from the database.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">first</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)).</span><span class="nx">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">select</span><span class="p">();</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              
<p>Runs a <code>select</code> query on the database, adding any necessary relational
constraints, resetting the query when complete. If there are results and
eager loaded relations, those are fetched and returned on the model before
the promise is resolved. Any <code>success</code> or <code>error</code> handlers passed in the
options will be called. An empty response will reject the deferred
with an <code>emptyResponse</code> message, and call/trigger the appropriate handlers.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">select</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">columns</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">filteredResp</span><span class="p">;</span>
        <span class="nx">model</span><span class="p">.</span><span class="nx">resetQuery</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">&amp;&amp;</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">filteredResp</span> <span class="o">=</span> <span class="nx">skim</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span></pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              
<p>If this is a model fetch, then we set the parsed attributes
on the model, otherwise, we reset the collection.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Model</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">filteredResp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">options</span><span class="p">),</span> <span class="nx">options</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">model</span><span class="p">.</span><span class="nx">reset</span><span class="p">(</span><span class="nx">filteredResp</span><span class="p">,</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">parse</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
          <span class="p">}</span>
          </pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              
<p>If the <code>withRelated</code> property is specified on the options hash, we dive
into the <code>EagerRelation</code>. If the current querying object is a collection, 
we find the associated <code>model</code> to determine necessary eager relations.
Once the <code>EagerRelation</code> is complete, we return the original response from the query.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">withRelated</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">target</span> <span class="o">=</span> <span class="p">(</span><span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Collection</span> <span class="o">?</span> <span class="k">new</span> <span class="nx">model</span><span class="p">.</span><span class="nx">model</span><span class="p">()</span> <span class="o">:</span> <span class="nx">model</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">EagerRelation</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">filteredResp</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">processRelated</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">resp</span><span class="p">;</span>
              <span class="p">});</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">resp</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="s1">&#39;emptyResponse&#39;</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="nx">model</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="s1">&#39;emptyResponse&#39;</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s1">&#39;emptyResponse&#39;</span><span class="p">);</span>
      <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="nx">model</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;fetched&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">resp</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              
<p>Issues an <code>insert</code> command on the query.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">insert</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">({</span><span class="nx">shallow</span><span class="o">:</span> <span class="kc">true</span><span class="p">}));</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              
<p>Issues an <code>update</code> command on the query.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">({</span><span class="nx">shallow</span><span class="o">:</span> <span class="kc">true</span><span class="p">}));</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              
<p>Issues a <code>delete</code> command on the query.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">del</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">del</span><span class="p">();</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              
<p>Alias to <code>del</code>.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="s2">&quot;delete&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">del</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span></pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              
<h2>Helpers</h2>

            </div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              
<p>Specific to many-to-many relationships, these methods are mixed
into the <code>belongsToMany</code> relationships when they are created,
providing helpers for attaching and detaching related models.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">pivotHelpers</span> <span class="o">=</span> <span class="p">{</span>

    <span class="nx">_handler</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">ids</span><span class="p">,</span> <span class="nx">transacting</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ids</span> <span class="o">==</span> <span class="k">void</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;insert&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">ids</span><span class="p">))</span> <span class="nx">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nx">ids</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">pivot</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relation</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">allResolved</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="nx">data</span><span class="p">[</span><span class="nx">pivot</span><span class="p">.</span><span class="nx">otherKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pivot</span><span class="p">.</span><span class="nx">fkValue</span><span class="p">;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              
<p>If the item is an object, it&#39;s either a model
that we&#39;re looking to attach to this model, or
a hash of attributes to set in the relation.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">item</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">item</span> <span class="k">instanceof</span> <span class="nx">Model</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">data</span><span class="p">[</span><span class="nx">pivot</span><span class="p">.</span><span class="nx">foreignKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">item</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">data</span><span class="p">[</span><span class="nx">pivot</span><span class="p">.</span><span class="nx">foreignKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">item</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">Knex</span><span class="p">(</span><span class="nx">pivot</span><span class="p">.</span><span class="nx">joinTableName</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">transacting</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">builder</span><span class="p">.</span><span class="nx">transacting</span><span class="p">(</span><span class="nx">transacting</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;delete&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">data</span><span class="p">).</span><span class="nx">del</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="p">}));</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              
<p>Attach one or more &quot;ids&quot; from a foreign
table to the current. Creates &amp; saves a new model
and attaches the model with a join table entry.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">attach</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_handler</span><span class="p">(</span><span class="s1">&#39;insert&#39;</span><span class="p">,</span> <span class="nx">ids</span><span class="p">,</span> <span class="p">(</span><span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">transacting</span><span class="p">));</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              
<p>Detach related object from their pivot tables.
If a model or id is passed, it attempts to remove the
pivot table based on that foreign key. If a hash is passed,
it attempts to remove the item based on a where clause with
these parameters. If no parameters are specified, we assume we will 
detach all related associations.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">detach</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_handler</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="nx">ids</span><span class="p">,</span> <span class="p">(</span><span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">transacting</span><span class="p">));</span>
    <span class="p">},</span></pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              
<p>Selects any additional columns on the pivot table,
taking a hash of columns which specifies the pivot
column name, and the value the column should take on the
output to the model attributes.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>    <span class="nx">withPivot</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">columns</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">relation</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relation</span><span class="p">;</span>
      <span class="nx">relation</span><span class="p">.</span><span class="nx">pivotColumns</span> <span class="o">||</span> <span class="p">(</span><span class="nx">relation</span><span class="p">.</span><span class="nx">pivotColumns</span> <span class="o">=</span> <span class="p">[]);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">columns</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">columns</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
        <span class="nx">relation</span><span class="p">.</span><span class="nx">pivotColumns</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">relation</span><span class="p">.</span><span class="nx">joinTableName</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s1">&#39; as &#39;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              
<p>Omit <code>parse</code> &amp; <code>toJSON</code>, from <code>Backbone</code> object conversions,
as these have different meanings on the client and server.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">converterOmit</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;parse&#39;</span><span class="p">,</span> <span class="s1">&#39;toJSON&#39;</span><span class="p">];</span></pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              
<p>Inherit standard Backbone.js Collections &amp; Models from the client,
transforming a client <code>Backbone.Model</code> or <code>Backbone.Collection</code> to a
<code>Bookshelf</code> compatible object, to reuse validations, defaults, methods, etc.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="nx">Model</span><span class="p">.</span><span class="nx">convert</span> <span class="o">=</span> <span class="nx">Collection</span><span class="p">.</span><span class="nx">convert</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Base</span><span class="p">,</span> <span class="nx">Target</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">omit</span><span class="p">(</span><span class="nx">Target</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">converterOmit</span><span class="p">));</span>
  <span class="p">};</span></pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              
<p>Returns the object&#39;s own properties.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">skim</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pick</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">};</span></pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              
<h2>Configuration</h2>

            </div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              
<p>Configure the <code>Bookshelf</code> settings (database adapter, etc.) once,
so it is ready on first model initialization.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>  <span class="nx">Bookshelf</span><span class="p">.</span><span class="nx">Initialize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Knex</span><span class="p">.</span><span class="nx">Initialize</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Bookshelf</span><span class="p">;</span>

<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
